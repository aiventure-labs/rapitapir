name: ğŸ’ Publish Gem

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  test:
    name: ğŸ§ª Pre-publish Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’ Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: ğŸ§ª Run full test suite
      run: bundle exec rspec
      
    - name: âœ… Validate gem build
      run: |
        gem build rapitapir.gemspec
        gem install ./rapitapir-*.gem
        ruby -e "require 'rapitapir'; puts 'Gem loads successfully!'"

  publish:
    name: ğŸ“¦ Publish to RubyGems
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’ Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
        
    - name: ğŸ”§ Configure RubyGems credentials
      env:
        RUBYGEMS_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
      run: |
        mkdir -p ~/.gem
        echo ":rubygems_api_key: $RUBYGEMS_API_KEY" > ~/.gem/credentials
        chmod 600 ~/.gem/credentials
        
    - name: ğŸ“¦ Build and publish gem
      run: |
        gem build rapitapir.gemspec
        gem push rapitapir-*.gem
        
    - name: ğŸ·ï¸ Create GitHub release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: RapiTapir ${{ github.ref_name }}
        body: |
          ## ğŸ¦™ RapiTapir ${{ github.ref_name }}
          
          ### ğŸš€ What's New
          
          This release includes bug fixes, performance improvements, and new features.
          
          ### ğŸ“¦ Installation
          
          ```bash
          gem install rapitapir
          ```
          
          ### ğŸ“– Documentation
          
          - [Getting Started Guide](https://github.com/riccardomerolla/rapitapir#-quick-start)
          - [API Documentation](https://github.com/riccardomerolla/rapitapir/blob/main/docs/)
          - [Examples](https://github.com/riccardomerolla/rapitapir/tree/main/examples)
          
          ### ğŸ¤ Contributing
          
          See our [Contributing Guide](https://github.com/riccardomerolla/rapitapir/blob/main/CONTRIBUTING.md) for how to get involved!
        draft: false
        prerelease: false

  notify:
    name: ğŸ“¢ Notify Community
    needs: [test, publish]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¢ Post to Ruby community (optional)
      run: |
        echo "ğŸ‰ RapiTapir ${{ github.ref_name }} has been published!"
        echo "Consider announcing on:"
        echo "- Ruby Weekly newsletter"
        echo "- Reddit r/ruby"
        echo "- Ruby Discord/Slack communities"
        echo "- Ruby Twitter community"
